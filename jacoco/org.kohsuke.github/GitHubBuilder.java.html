<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GitHubBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GitHub API for Java</a> &gt; <a href="index.source.html" class="el_package">org.kohsuke.github</a> &gt; <span class="el_source">GitHubBuilder.java</span></div><h1>GitHubBuilder.java</h1><pre class="source lang-java linenums">package org.kohsuke.github;

import org.apache.commons.io.IOUtils;
import org.kohsuke.github.extras.ImpatientHttpConnector;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.net.HttpURLConnection;
import java.net.Proxy;
import java.util.Locale;
import java.util.Map.Entry;
import java.util.Properties;

import javax.annotation.Nonnull;

/**
 * Configures connection details and produces {@link GitHub}.
 *
 * @since 1.59
 */
public class GitHubBuilder implements Cloneable {

    // default scoped so unit tests can read them.
<span class="fc" id="L26">    /* private */ String endpoint = GitHubClient.GITHUB_URL;</span>
    /* private */ String user;
    /* private */ String password;
    /* private */ String oauthToken;
    /* private */ String jwtToken;

    private HttpConnector connector;

<span class="fc" id="L34">    private RateLimitHandler rateLimitHandler = RateLimitHandler.WAIT;</span>
<span class="fc" id="L35">    private AbuseLimitHandler abuseLimitHandler = AbuseLimitHandler.WAIT;</span>
<span class="fc" id="L36">    private GitHubRateLimitChecker rateLimitChecker = new GitHubRateLimitChecker();</span>

    /**
     * Instantiates a new Git hub builder.
     */
<span class="fc" id="L41">    public GitHubBuilder() {</span>
<span class="fc" id="L42">    }</span>

    /**
     * First check if the credentials are configured in the environment. We use environment first because users are not
     * likely to give required (full) permissions to their default key.
     *
     * If no user is specified it means there is no configuration present, so try using the ~/.github properties file.
     **
     * If there is still no user it means there are no credentials defined and throw an IOException.
     *
     * @return the configured Builder from credentials defined on the system or in the environment. Otherwise returns
     *         null.
     *
     * @throws IOException
     *             If there are no credentials defined in the ~/.github properties file or the process environment.
     */
    static GitHubBuilder fromCredentials() throws IOException {
<span class="fc" id="L59">        Exception cause = null;</span>
<span class="fc" id="L60">        GitHubBuilder builder = null;</span>

<span class="fc" id="L62">        builder = fromEnvironment();</span>

<span class="pc bpc" id="L64" title="2 of 6 branches missed.">        if (builder.oauthToken != null || builder.user != null || builder.jwtToken != null)</span>
<span class="fc" id="L65">            return builder;</span>

        try {
<span class="fc" id="L68">            builder = fromPropertyFile();</span>

<span class="pc bpc" id="L70" title="5 of 6 branches missed.">            if (builder.oauthToken != null || builder.user != null || builder.jwtToken != null)</span>
<span class="fc" id="L71">                return builder;</span>
<span class="nc" id="L72">        } catch (FileNotFoundException e) {</span>
            // fall through
<span class="nc" id="L74">            cause = e;</span>
<span class="nc" id="L75">        }</span>
<span class="nc" id="L76">        throw (IOException) new IOException(&quot;Failed to resolve credentials from ~/.github or the environment.&quot;)</span>
<span class="nc" id="L77">                .initCause(cause);</span>
    }

    /**
     * From environment git hub builder.
     *
     * @param loginVariableName
     *            the login variable name
     * @param passwordVariableName
     *            the password variable name
     * @param oauthVariableName
     *            the oauth variable name
     * @return the git hub builder
     * @throws IOException
     *             the io exception
     * @deprecated Use {@link #fromEnvironment()} to pick up standard set of environment variables, so that different
     *             clients of this library will all recognize one consistent set of coordinates.
     */
    @Deprecated
    public static GitHubBuilder fromEnvironment(String loginVariableName,
            String passwordVariableName,
            String oauthVariableName) throws IOException {
<span class="nc" id="L99">        return fromEnvironment(loginVariableName, passwordVariableName, oauthVariableName, &quot;&quot;);</span>
    }

    private static void loadIfSet(String envName, Properties p, String propName) {
<span class="fc" id="L103">        String v = System.getenv(envName);</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">        if (v != null)</span>
<span class="fc" id="L105">            p.put(propName, v);</span>
<span class="fc" id="L106">    }</span>

    /**
     * From environment git hub builder.
     *
     * @param loginVariableName
     *            the login variable name
     * @param passwordVariableName
     *            the password variable name
     * @param oauthVariableName
     *            the oauth variable name
     * @param endpointVariableName
     *            the endpoint variable name
     * @return the git hub builder
     * @throws IOException
     *             the io exception
     * @deprecated Use {@link #fromEnvironment()} to pick up standard set of environment variables, so that different
     *             clients of this library will all recognize one consistent set of coordinates.
     */
    @Deprecated
    public static GitHubBuilder fromEnvironment(String loginVariableName,
            String passwordVariableName,
            String oauthVariableName,
            String endpointVariableName) throws IOException {
<span class="fc" id="L130">        Properties env = new Properties();</span>
<span class="fc" id="L131">        loadIfSet(loginVariableName, env, &quot;login&quot;);</span>
<span class="fc" id="L132">        loadIfSet(passwordVariableName, env, &quot;password&quot;);</span>
<span class="fc" id="L133">        loadIfSet(oauthVariableName, env, &quot;oauth&quot;);</span>
<span class="fc" id="L134">        loadIfSet(endpointVariableName, env, &quot;endpoint&quot;);</span>
<span class="fc" id="L135">        return fromProperties(env);</span>
    }

    /**
     * Creates {@link GitHubBuilder} by picking up coordinates from environment variables.
     *
     * &lt;p&gt;
     * The following environment variables are recognized:
     *
     * &lt;ul&gt;
     * &lt;li&gt;GITHUB_LOGIN: username like 'kohsuke'
     * &lt;li&gt;GITHUB_PASSWORD: raw password
     * &lt;li&gt;GITHUB_OAUTH: OAuth token to login
     * &lt;li&gt;GITHUB_ENDPOINT: URL of the API endpoint
     * &lt;li&gt;GITHUB_JWT: JWT token to login
     * &lt;/ul&gt;
     *
     * &lt;p&gt;
     * See class javadoc for the relationship between these coordinates.
     *
     * &lt;p&gt;
     * For backward compatibility, the following environment variables are recognized but discouraged: login, password,
     * oauth
     *
     * @return the git hub builder
     * @throws IOException
     *             the io exception
     */
    public static GitHubBuilder fromEnvironment() throws IOException {
<span class="fc" id="L164">        Properties props = new Properties();</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">        for (Entry&lt;String, String&gt; e : System.getenv().entrySet()) {</span>
<span class="fc" id="L166">            String name = e.getKey().toLowerCase(Locale.ENGLISH);</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">            if (name.startsWith(&quot;github_&quot;))</span>
<span class="nc" id="L168">                name = name.substring(7);</span>
<span class="fc" id="L169">            props.put(name, e.getValue());</span>
<span class="fc" id="L170">        }</span>
<span class="fc" id="L171">        return fromProperties(props);</span>
    }

    /**
     * From property file git hub builder.
     *
     * @return the git hub builder
     * @throws IOException
     *             the io exception
     */
    public static GitHubBuilder fromPropertyFile() throws IOException {
<span class="fc" id="L182">        File homeDir = new File(System.getProperty(&quot;user.home&quot;));</span>
<span class="fc" id="L183">        File propertyFile = new File(homeDir, &quot;.github&quot;);</span>
<span class="fc" id="L184">        return fromPropertyFile(propertyFile.getPath());</span>
    }

    /**
     * From property file git hub builder.
     *
     * @param propertyFileName
     *            the property file name
     * @return the git hub builder
     * @throws IOException
     *             the io exception
     */
    public static GitHubBuilder fromPropertyFile(String propertyFileName) throws IOException {
<span class="fc" id="L197">        Properties props = new Properties();</span>
<span class="fc" id="L198">        FileInputStream in = null;</span>
        try {
<span class="fc" id="L200">            in = new FileInputStream(propertyFileName);</span>
<span class="fc" id="L201">            props.load(in);</span>
        } finally {
<span class="fc" id="L203">            IOUtils.closeQuietly(in);</span>
        }

<span class="fc" id="L206">        return fromProperties(props);</span>
    }

    /**
     * From properties git hub builder.
     *
     * @param props
     *            the props
     * @return the git hub builder
     */
    public static GitHubBuilder fromProperties(Properties props) {
<span class="fc" id="L217">        GitHubBuilder self = new GitHubBuilder();</span>
<span class="fc" id="L218">        self.withOAuthToken(props.getProperty(&quot;oauth&quot;), props.getProperty(&quot;login&quot;));</span>
<span class="fc" id="L219">        self.withJwtToken(props.getProperty(&quot;jwt&quot;));</span>
<span class="fc" id="L220">        self.withPassword(props.getProperty(&quot;login&quot;), props.getProperty(&quot;password&quot;));</span>
<span class="fc" id="L221">        self.withEndpoint(props.getProperty(&quot;endpoint&quot;, GitHubClient.GITHUB_URL));</span>
<span class="fc" id="L222">        return self;</span>
    }

    /**
     * With endpoint git hub builder.
     *
     * @param endpoint
     *            The URL of GitHub (or GitHub enterprise) API endpoint, such as &quot;https://api.github.com&quot; or
     *            &quot;http://ghe.acme.com/api/v3&quot;. Note that GitHub Enterprise has &lt;code&gt;/api/v3&lt;/code&gt; in the URL. For
     *            historical reasons, this parameter still accepts the bare domain name, but that's considered
     *            deprecated.
     * @return the git hub builder
     */
    public GitHubBuilder withEndpoint(String endpoint) {
<span class="fc" id="L236">        this.endpoint = endpoint;</span>
<span class="fc" id="L237">        return this;</span>
    }

    /**
     * With password git hub builder.
     *
     * @param user
     *            the user
     * @param password
     *            the password
     * @return the git hub builder
     */
    public GitHubBuilder withPassword(String user, String password) {
<span class="fc" id="L250">        this.user = user;</span>
<span class="fc" id="L251">        this.password = password;</span>
<span class="fc" id="L252">        return this;</span>
    }

    /**
     * With o auth token git hub builder.
     *
     * @param oauthToken
     *            the oauth token
     * @return the git hub builder
     */
    public GitHubBuilder withOAuthToken(String oauthToken) {
<span class="nc" id="L263">        return withOAuthToken(oauthToken, null);</span>
    }

    /**
     * With o auth token git hub builder.
     *
     * @param oauthToken
     *            the oauth token
     * @param user
     *            the user
     * @return the git hub builder
     */
    public GitHubBuilder withOAuthToken(String oauthToken, String user) {
<span class="fc" id="L276">        this.oauthToken = oauthToken;</span>
<span class="fc" id="L277">        this.user = user;</span>
<span class="fc" id="L278">        return this;</span>
    }

    /**
     * Configures {@link GitHubBuilder} with Installation Token generated by the GitHub Application
     *
     * @param appInstallationToken
     *            A string containing the GitHub App installation token
     * @return the configured Builder from given GitHub App installation token.
     * @see GHAppInstallation#createToken(java.util.Map) GHAppInstallation#createToken(java.util.Map)
     */
    public GitHubBuilder withAppInstallationToken(String appInstallationToken) {
<span class="fc" id="L290">        return withOAuthToken(appInstallationToken, &quot;&quot;);</span>
    }

    /**
     * With jwt token git hub builder.
     *
     * @param jwtToken
     *            the jwt token
     * @return the git hub builder
     */
    public GitHubBuilder withJwtToken(String jwtToken) {
<span class="fc" id="L301">        this.jwtToken = jwtToken;</span>
<span class="fc" id="L302">        return this;</span>
    }

    /**
     * With connector git hub builder.
     *
     * @param connector
     *            the connector
     * @return the git hub builder
     */
    public GitHubBuilder withConnector(HttpConnector connector) {
<span class="fc" id="L313">        this.connector = connector;</span>
<span class="fc" id="L314">        return this;</span>
    }

    /**
     * Adds a {@link RateLimitHandler} to this {@link GitHubBuilder}.
     * &lt;p&gt;
     * GitHub allots a certain number of requests to each user or application per period of time (usually per hour). The
     * number of requests remaining is returned in the response header and can also be requested using
     * {@link GitHub#getRateLimit()}. This requests per interval is referred to as the &quot;rate limit&quot;.
     * &lt;/p&gt;
     * &lt;p&gt;
     * When the remaining number of requests reaches zero, the next request will return an error. If this happens,
     * {@link RateLimitHandler#onError(IOException, HttpURLConnection)} will be called.
     * &lt;/p&gt;
     * &lt;p&gt;
     * NOTE: GitHub treats clients that exceed their rate limit very harshly. If possible, clients should avoid
     * exceeding their rate limit. Consider adding a {@link RateLimitChecker} to automatically check the rate limit for
     * each request and wait if needed.
     * &lt;/p&gt;
     *
     * @param handler
     *            the handler
     * @return the git hub builder
     * @see #withRateLimitChecker(RateLimitChecker)
     */
    public GitHubBuilder withRateLimitHandler(RateLimitHandler handler) {
<span class="fc" id="L340">        this.rateLimitHandler = handler;</span>
<span class="fc" id="L341">        return this;</span>
    }

    /**
     * Adds a {@link AbuseLimitHandler} to this {@link GitHubBuilder}.
     * &lt;p&gt;
     * When a client sends too many requests in a short time span, GitHub may return an error and set a header telling
     * the client to not make any more request for some period of time. If this happens,
     * {@link AbuseLimitHandler#onError(IOException, HttpURLConnection)} will be called.
     * &lt;/p&gt;
     *
     * @param handler
     *            the handler
     * @return the git hub builder
     */
    public GitHubBuilder withAbuseLimitHandler(AbuseLimitHandler handler) {
<span class="fc" id="L357">        this.abuseLimitHandler = handler;</span>
<span class="fc" id="L358">        return this;</span>
    }

    /**
     * Adds a {@link RateLimitChecker} for the Core API for this {@link GitHubBuilder}.
     *
     * @param coreRateLimitChecker
     *            the {@link RateLimitChecker} for core GitHub API requests
     * @return the git hub builder
     * @see #withRateLimitChecker(RateLimitChecker, RateLimitTarget)
     */
    public GitHubBuilder withRateLimitChecker(@Nonnull RateLimitChecker coreRateLimitChecker) {
<span class="fc" id="L370">        return withRateLimitChecker(coreRateLimitChecker, RateLimitTarget.CORE);</span>
    }

    /**
     * Adds a {@link RateLimitChecker} to this {@link GitHubBuilder}.
     * &lt;p&gt;
     * GitHub allots a certain number of requests to each user or application per period of time (usually per hour). The
     * number of requests remaining is returned in the response header and can also be requested using
     * {@link GitHub#getRateLimit()}. This requests per interval is referred to as the &quot;rate limit&quot;.
     * &lt;/p&gt;
     * &lt;p&gt;
     * GitHub prefers that clients stop before exceeding their rate limit rather than stopping after they exceed it. The
     * {@link RateLimitChecker} is called before each request to check the rate limit and wait if the checker criteria
     * are met.
     * &lt;/p&gt;
     * &lt;p&gt;
     * Checking your rate limit using {@link GitHub#getRateLimit()} does not effect your rate limit, but each
     * {@link GitHub} instance will attempt to cache and reuse the last seen rate limit rather than making a new
     * request.
     * &lt;/p&gt;
     *
     * @param rateLimitChecker
     *            the {@link RateLimitChecker} for requests
     * @param rateLimitTarget
     *            the {@link RateLimitTarget} specifying which rate limit record to check
     * @return the git hub builder
     */
    public GitHubBuilder withRateLimitChecker(@Nonnull RateLimitChecker rateLimitChecker,
            @Nonnull RateLimitTarget rateLimitTarget) {
<span class="fc" id="L399">        this.rateLimitChecker = this.rateLimitChecker.with(rateLimitChecker, rateLimitTarget);</span>
<span class="fc" id="L400">        return this;</span>
    }

    /**
     * Configures {@linkplain #withConnector(HttpConnector) connector} that uses HTTP library in JRE but use a specific
     * proxy, instead of the system default one.
     *
     * @param p
     *            the p
     * @return the git hub builder
     */
    public GitHubBuilder withProxy(final Proxy p) {
<span class="nc" id="L412">        return withConnector(new ImpatientHttpConnector(url -&gt; (HttpURLConnection) url.openConnection(p)));</span>
    }

    /**
     * Builds a {@link GitHub} instance.
     *
     * @return the git hub
     * @throws IOException
     *             the io exception
     */
    public GitHub build() throws IOException {
<span class="fc" id="L423">        return new GitHub(endpoint,</span>
                user,
                oauthToken,
                jwtToken,
                password,
                connector,
                rateLimitHandler,
                abuseLimitHandler,
                rateLimitChecker);
    }

    @Override
    public GitHubBuilder clone() {
        try {
<span class="fc" id="L437">            return (GitHubBuilder) super.clone();</span>
<span class="nc" id="L438">        } catch (CloneNotSupportedException e) {</span>
<span class="nc" id="L439">            throw new RuntimeException(&quot;Clone should be supported&quot;, e);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>